<!-- í”„ë¡œëª¨ì…˜ í• ë‹¹ í˜ì´ì§€ (LLM ì„¤ê³„ ê¸°ë°˜ ì „ë©´ ì¬êµ¬ì„±) -->
<div id="promotionAssignPage">
  <h1 class="title">í”„ë¡œëª¨ì…˜ í• ë‹¹ ê´€ë¦¬</h1>
  <p class="subtitle">ì²« ê²°ì œ ì˜ˆì • ê³ ê° ëŒ€ìƒ í”„ë¡œëª¨ì…˜ ìš´ì˜</p>

  <!-- â‘  ìƒë‹¨: í”„ë¡œëª¨ì…˜ ëŒ€ìƒ íšŒì› ë¦¬ìŠ¤íŠ¸ (ë©”ì¸ í…Œì´ë¸”) -->
  <div class="box">
    <div class="level">
      <div class="level-left">
        <div class="level-item">
          <h5 class="title is-5">ğŸ“‹ ì²« ê²°ì œ ì˜ˆì • ê³ ê° ëª©ë¡</h5>
        </div>
      </div>
      <div class="level-right">
        <div class="level-item">
          <div class="field has-addons">
            <div class="control">
              <input class="input" type="text" placeholder="ì•½ì‚¬ëª… ê²€ìƒ‰" id="filterPharmacistName">
            </div>
            <div class="control">
              <input class="input" type="text" placeholder="ì•½êµ­ëª… ê²€ìƒ‰" id="filterPharmacyName">
            </div>
            <div class="control">
              <button class="button is-info" onclick="loadCandidatesList()">
                <span class="icon"><i class="fas fa-search"></i></span>
                <span>ê²€ìƒ‰</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table class="table is-fullwidth is-hoverable is-striped">
        <thead>
          <tr>
            <th style="width: 50px;">
              <input type="checkbox" id="selectAllCandidates" onchange="toggleSelectAll()">
            </th>
            <th>íšŒì›ëª… / ì•½êµ­ëª…</th>
            <th>ì‚¬ì—…ìë²ˆí˜¸</th>
            <th>ê°€ì…ì¼</th>
            <th>êµ¬ë… ìƒíƒœ</th>
            <th>
              <span class="has-tooltip-arrow" data-tooltip="billing_payments ê¸°ì¤€ ì²« ê²°ì œ ì—¬ë¶€">
                ì²« ê²°ì œ ì—¬ë¶€ â„¹ï¸
              </span>
            </th>
            <th>ë‹¤ìŒ ê²°ì œ ì˜ˆì •ì¼</th>
            <th>í”„ë¡œëª¨ì…˜ ìƒíƒœ</th>
            <th style="width: 150px;">ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody id="candidatesTableBody">
          <tr>
            <td colspan="9" class="has-text-centered">ë¡œë”© ì¤‘...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ì„ íƒëœ íšŒì› ìˆ˜ í‘œì‹œ -->
    <div class="notification is-light" id="selectedCountNotification" style="display: none;">
      <strong id="selectedCountText">0ëª… ì„ íƒë¨</strong>
      <button class="delete" onclick="clearSelection()"></button>
    </div>

    <!-- í•˜ë‹¨: í”„ë¡œëª¨ì…˜ í• ë‹¹ ì˜ì—­ -->
    <div class="box has-background-light" id="bulkAssignSection" style="display: none;">
      <h6 class="title is-6">ğŸ ì„ íƒí•œ íšŒì›ì—ê²Œ í”„ë¡œëª¨ì…˜ í• ë‹¹</h6>
      
      <div class="columns">
        <div class="column is-8">
          <div class="field">
            <label class="label">í”„ë¡œëª¨ì…˜ ì„ íƒ <span class="has-text-danger">*</span></label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="bulkPromotionSelect">
                  <option value="">í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
              </div>
            </div>
            <p class="help">âœ… ì²« ê²°ì œ ì „ìš© í”„ë¡œëª¨ì…˜ë§Œ í‘œì‹œë©ë‹ˆë‹¤</p>
          </div>
        </div>
        <div class="column is-4">
          <label class="label">ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
          <div class="control">
            <input class="input" type="text" placeholder="ì˜ˆ: ì˜¤í”ˆ ì´ë²¤íŠ¸" id="bulkAssignMemo">
          </div>
        </div>
      </div>

      <div class="field">
        <div class="control">
          <button class="button is-primary" onclick="executeBulkAssign()">
            <span class="icon"><i class="fas fa-paper-plane"></i></span>
            <span id="bulkAssignButtonText">0ëª…ì—ê²Œ í”„ë¡œëª¨ì…˜ í• ë‹¹</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- â‘¡ íšŒì› ìƒì„¸ íŒ¨ë„ (Modal) -->
  <div class="modal" id="userDetailModal">
    <div class="modal-background" onclick="closeUserDetailModal()"></div>
    <div class="modal-card" style="width: 900px;">
      <header class="modal-card-head">
        <p class="modal-card-title">ğŸ” íšŒì› ìƒì„¸ ì •ë³´ ë° í”„ë¡œëª¨ì…˜ íŒë‹¨</p>
        <button class="delete" aria-label="close" onclick="closeUserDetailModal()"></button>
      </header>
      <section class="modal-card-body">
        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="box">
          <h6 class="title is-6">ê¸°ë³¸ ì •ë³´</h6>
          <div class="columns is-multiline" id="userBasicInfo">
            <div class="column is-6">
              <strong>ì•½ì‚¬ëª…:</strong> <span id="detailPharmacistName">-</span>
            </div>
            <div class="column is-6">
              <strong>ì•½êµ­ëª…:</strong> <span id="detailPharmacyName">-</span>
            </div>
            <div class="column is-6">
              <strong>ì´ë©”ì¼:</strong> <span id="detailEmail">-</span>
            </div>
            <div class="column is-6">
              <strong>ì „í™”ë²ˆí˜¸:</strong> <span id="detailPhone">-</span>
            </div>
            <div class="column is-12">
              <strong>ì‚¬ì—…ìë²ˆí˜¸:</strong> <span id="detailBusinessNumber">-</span>
            </div>
          </div>
        </div>

        <!-- (A) í”„ë¡œëª¨ì…˜ ì´ë ¥ ìš”ì•½ -->
        <div class="box has-background-warning-light">
          <h6 class="title is-6">ğŸ“Š í”„ë¡œëª¨ì…˜ ì´ë ¥ ìš”ì•½ (promotion_usage_history)</h6>
          <div id="promotionHistorySummary">
            <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
          </div>
        </div>

        <!-- (B) êµ¬ë… / ê²°ì œ ìƒíƒœ ìš”ì•½ -->
        <div class="box has-background-info-light">
          <h6 class="title is-6">ğŸ’³ êµ¬ë… / ê²°ì œ ìƒíƒœ (user_subscriptions + billing_payments)</h6>
          <div id="subscriptionSummary">
            <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
          </div>
        </div>

        <!-- (C) ì˜ˆì•½ëœ í”„ë¡œëª¨ì…˜ (pending_user_promotions) -->
        <div class="box has-background-success-light">
          <h6 class="title is-6">ğŸ ì˜ˆì•½ëœ í”„ë¡œëª¨ì…˜ (pending_user_promotions)</h6>
          <div id="pendingPromotionsList">
            <p class="has-text-centered">ë¡œë”© ì¤‘...</p>
          </div>
        </div>

        <!-- â‘¢ í”„ë¡œëª¨ì…˜ í• ë‹¹ ì•¡ì…˜ -->
        <div class="box has-background-light">
          <h6 class="title is-6">ğŸ¯ ì´ íšŒì›ì—ê²Œ í”„ë¡œëª¨ì…˜ í• ë‹¹</h6>
          
          <div id="assignmentEligibilityCheck">
            <!-- ìê²© íŒë‹¨ ë©”ì‹œì§€ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
          </div>

          <div class="field">
            <label class="label">í”„ë¡œëª¨ì…˜ ì„ íƒ</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="singlePromotionSelect">
                  <option value="">í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label">ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
            <div class="control">
              <input class="input" type="text" placeholder="ì˜ˆ: CS ëŒ€ì‘, ì˜ì—…ìš©" id="singleAssignMemo">
            </div>
          </div>

          <div class="field">
            <div class="control">
              <button class="button is-primary" id="singleAssignButton" onclick="executeSingleAssign()">
                <span class="icon"><i class="fas fa-paper-plane"></i></span>
                <span>í”„ë¡œëª¨ì…˜ í• ë‹¹</span>
              </button>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button" onclick="closeUserDetailModal()">ë‹«ê¸°</button>
      </footer>
    </div>
  </div>

  <!-- í• ë‹¹ ë‚´ì—­ ì„¹ì…˜ -->
  <div class="box">
    <div class="level">
      <div class="level-left">
        <div class="level-item">
          <h5 class="title is-5">ğŸ“œ í”„ë¡œëª¨ì…˜ í• ë‹¹ ë‚´ì—­</h5>
        </div>
      </div>
      <div class="level-right">
        <div class="level-item">
          <button class="button is-light" onclick="loadAssignmentList()">
            <span class="icon"><i class="fas fa-sync"></i></span>
            <span>ìƒˆë¡œê³ ì¹¨</span>
          </button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table class="table is-fullwidth is-hoverable">
        <thead>
          <tr>
            <th>íšŒì›</th>
            <th>í”„ë¡œëª¨ì…˜</th>
            <th>í• ì¸ ì •ë³´</th>
            <th>í• ë‹¹ì¼</th>
            <th>ì ìš©ì¼</th>
            <th>ìƒíƒœ</th>
            <th>ì†ŒìŠ¤</th>
            <th style="width: 100px;">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="assignmentTableBody">
          <tr>
            <td colspan="8" class="has-text-centered">ë¡œë”© ì¤‘...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .has-tooltip-arrow {
    position: relative;
    cursor: help;
    border-bottom: 1px dotted #aaa;
  }
  
  .candidate-row:hover {
    background-color: #f0f8ff;
  }
  
  .status-reserved { color: #3273dc; }
  .status-selected { color: #ff9800; }
  .status-applied { color: #48c774; }
  .status-expired { color: #888; }
  .status-cancelled { color: #f14668; }
</style>

<script>
  // ===========================
  // í”„ë¡œëª¨ì…˜ í• ë‹¹ í˜ì´ì§€ ì „ì—­ ë³€ìˆ˜
  // ===========================
  let candidatesList = [];
  let selectedCandidates = [];
  let currentUserDetail = null;

  // ===========================
  // í˜ì´ì§€ ë¡œë“œ
  // ===========================
  async function initPromotionAssignPage() {
    await loadCandidatesList();
    await loadFirstPaymentPromotions();
    await loadAssignmentList();
  }

  // ===========================
  // â‘  ì²« ê²°ì œ ì˜ˆì • ê³ ê° ëª©ë¡ ì¡°íšŒ
  // ===========================
  async function loadCandidatesList() {
    const pharmacistName = document.getElementById('filterPharmacistName').value.trim();
    const pharmacyName = document.getElementById('filterPharmacyName').value.trim();

    try {
      const params = new URLSearchParams();
      if (pharmacistName) params.append('pharmacist_name', pharmacistName);
      if (pharmacyName) params.append('pharmacy_name', pharmacyName);

      const response = await fetch('/admin/api/assign-promotion/candidates?' + params, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
        }
      });

      const data = await response.json();
      candidatesList = data.candidates || [];

      renderCandidatesTable();
    } catch (error) {
      console.error('í›„ë³´ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', error);
      document.getElementById('candidatesTableBody').innerHTML = 
        '<tr><td colspan="9" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
    }
  }

  function renderCandidatesTable() {
    const tbody = document.getElementById('candidatesTableBody');

    if (candidatesList.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="has-text-centered">ì²« ê²°ì œ ì˜ˆì • ê³ ê°ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
      return;
    }

    tbody.innerHTML = candidatesList.map((user, index) => {
      const firstPaymentBadge = user.is_first_payment 
        ? '<span class="tag is-success">âœ… ì²« ê²°ì œ</span>' 
        : '<span class="tag is-danger">âŒ ê¸°ì¡´ ê³ ê°</span>';

      const subscriptionBadge = user.subscription_status 
        ? `<span class="tag is-info">${user.subscription_status}</span>` 
        : '<span class="tag is-light">ì—†ìŒ</span>';

      const promotionStatusBadge = user.has_pending_promotion
        ? '<span class="tag is-warning">ì˜ˆì•½ë¨</span>'
        : '<span class="tag is-light">ì—†ìŒ</span>';

      return `
        <tr class="candidate-row">
          <td class="has-text-centered">
            <input type="checkbox" class="candidate-checkbox" value="${user.user_id}" 
              data-index="${index}" onchange="updateSelectionState()">
          </td>
          <td>
            <strong>${user.pharmacist_name || '-'}</strong><br>
            <small>${user.pharmacy_name || '-'}</small>
          </td>
          <td><small>${user.business_number || '-'}</small></td>
          <td><small>${new Date(user.created_at).toLocaleDateString('ko-KR')}</small></td>
          <td>${subscriptionBadge}</td>
          <td>${firstPaymentBadge}</td>
          <td>${user.next_billing_at ? new Date(user.next_billing_at).toLocaleString('ko-KR') : '-'}</td>
          <td>${promotionStatusBadge}</td>
          <td>
            <button class="button is-small is-info" onclick="openUserDetailModal('${user.user_id}')">
              <span class="icon"><i class="fas fa-search"></i></span>
              <span>ìƒì„¸</span>
            </button>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ===========================
  // ì„ íƒ ìƒíƒœ ê´€ë¦¬
  // ===========================
  function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllCandidates').checked;
    const checkboxes = document.querySelectorAll('.candidate-checkbox');
    
    checkboxes.forEach(cb => cb.checked = selectAll);
    updateSelectionState();
  }

  function updateSelectionState() {
    const checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
    selectedCandidates = Array.from(checkboxes).map(cb => {
      const index = parseInt(cb.dataset.index);
      return candidatesList[index];
    });

    const count = selectedCandidates.length;
    const notification = document.getElementById('selectedCountNotification');
    const bulkSection = document.getElementById('bulkAssignSection');
    const countText = document.getElementById('selectedCountText');
    const buttonText = document.getElementById('bulkAssignButtonText');

    if (count > 0) {
      notification.style.display = 'block';
      bulkSection.style.display = 'block';
      countText.textContent = `${count}ëª… ì„ íƒë¨`;
      buttonText.textContent = `${count}ëª…ì—ê²Œ í”„ë¡œëª¨ì…˜ í• ë‹¹`;
    } else {
      notification.style.display = 'none';
      bulkSection.style.display = 'none';
    }
  }

  function clearSelection() {
    document.getElementById('selectAllCandidates').checked = false;
    document.querySelectorAll('.candidate-checkbox').forEach(cb => cb.checked = false);
    updateSelectionState();
  }

  // ===========================
  // ì²« ê²°ì œ ì „ìš© í”„ë¡œëª¨ì…˜ ì¡°íšŒ
  // ===========================
  async function loadFirstPaymentPromotions() {
    try {
      const response = await fetch('/admin/api/promotions', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
        }
      });

      const data = await response.json();
      const promotions = (data.promotions || []).filter(p => p.is_active && p.first_payment_only);

      const options = promotions.map(p => {
        let discountInfo = '';
        if (p.discount_type === 'free') {
          discountInfo = `${p.free_months}ê°œì›” ë¬´ë£Œ`;
        } else if (p.discount_type === 'percent') {
          discountInfo = `${p.discount_value}% í• ì¸`;
        } else if (p.discount_type === 'amount') {
          discountInfo = `${p.discount_value.toLocaleString()}ì› í• ì¸`;
        }
        return `<option value="${p.promotion_id}">${p.promotion_name} (${discountInfo})</option>`;
      }).join('');

      document.getElementById('bulkPromotionSelect').innerHTML = 
        '<option value="">í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>' + options;
      document.getElementById('singlePromotionSelect').innerHTML = 
        '<option value="">í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>' + options;

    } catch (error) {
      console.error('í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
    }
  }

  // ===========================
  // ì¼ê´„ í• ë‹¹
  // ===========================
  async function executeBulkAssign() {
    const promotionId = document.getElementById('bulkPromotionSelect').value;
    const memo = document.getElementById('bulkAssignMemo').value.trim();

    if (!promotionId) {
      alert('í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    if (selectedCandidates.length === 0) {
      alert('í• ë‹¹ ëŒ€ìƒ íšŒì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    if (!confirm(`${selectedCandidates.length}ëª…ì—ê²Œ í”„ë¡œëª¨ì…˜ì„ í• ë‹¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }

    try {
      const response = await fetch('/admin/api/assign-promotion', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          promotion_id: promotionId,
          user_ids: selectedCandidates.map(u => u.user_id),
          memo: memo || null
        })
      });

      const result = await response.json();

      if (result.success) {
        alert(result.message || 'í”„ë¡œëª¨ì…˜ì´ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.');
        clearSelection();
        await loadCandidatesList();
        await loadAssignmentList();
      } else {
        alert('í• ë‹¹ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }

    } catch (error) {
      console.error('ì¼ê´„ í• ë‹¹ ì˜¤ë¥˜:', error);
      alert('í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ===========================
  // íšŒì› ìƒì„¸ ëª¨ë‹¬
  // ===========================
  async function openUserDetailModal(userId) {
    document.getElementById('userDetailModal').classList.add('is-active');
    
    const user = candidatesList.find(u => u.user_id === userId);
    if (!user) {
      alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    currentUserDetail = user;

    // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
    document.getElementById('detailPharmacistName').textContent = user.pharmacist_name || '-';
    document.getElementById('detailPharmacyName').textContent = user.pharmacy_name || '-';
    document.getElementById('detailEmail').textContent = user.email || '-';
    document.getElementById('detailPhone').textContent = user.pharmacist_phone || '-';
    document.getElementById('detailBusinessNumber').textContent = user.business_number || '-';

    // ìƒì„¸ ì •ë³´ ë¡œë“œ
    await loadUserPromotionHistory(userId, user.business_number);
    await loadUserSubscriptionStatus(userId);
    await loadUserPendingPromotions(userId);
    checkAssignmentEligibility(user);
  }

  function closeUserDetailModal() {
    document.getElementById('userDetailModal').classList.remove('is-active');
    currentUserDetail = null;
  }

  // í”„ë¡œëª¨ì…˜ ì´ë ¥ ì¡°íšŒ
  async function loadUserPromotionHistory(userId, businessNumber) {
    try {
      const response = await fetch(`/admin/api/users/${userId}/promotion-history?business_number=${businessNumber}`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
        }
      });

      const data = await response.json();
      const history = data.history || [];

      const summaryDiv = document.getElementById('promotionHistorySummary');

      if (history.length === 0) {
        summaryDiv.innerHTML = '<p class="has-text-centered">âœ… í”„ë¡œëª¨ì…˜ ì‚¬ìš© ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤ (ì‹ ê·œ ê³ ê°)</p>';
        return;
      }

      summaryDiv.innerHTML = `
        <table class="table is-fullwidth is-narrow">
          <thead>
            <tr>
              <th>í”„ë¡œëª¨ì…˜ ì½”ë“œ</th>
              <th>ì‚¬ìš© ê°œì›”</th>
              <th>ì†Œì§„ ì—¬ë¶€</th>
              <th>ë§ˆì§€ë§‰ ì‚¬ìš©</th>
            </tr>
          </thead>
          <tbody>
            ${history.map(h => `
              <tr>
                <td>${h.promotion_code}</td>
                <td>${h.used_months}ê°œì›”</td>
                <td>${h.is_exhausted ? '<span class="tag is-danger">ì†Œì§„</span>' : '<span class="tag is-success">ê°€ëŠ¥</span>'}</td>
                <td>${h.last_applied_at ? new Date(h.last_applied_at).toLocaleString('ko-KR') : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        <p class="notification is-warning is-light">
          âš ï¸ ì´ ì‚¬ì—…ìëŠ” ê³¼ê±° í”„ë¡œëª¨ì…˜ í˜œíƒì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì²« ê²°ì œ ì „ìš© í”„ë¡œëª¨ì…˜ì€ í• ë‹¹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
      `;

    } catch (error) {
      console.error('í”„ë¡œëª¨ì…˜ ì´ë ¥ ì¡°íšŒ ì˜¤ë¥˜:', error);
      document.getElementById('promotionHistorySummary').innerHTML = 
        '<p class="has-text-danger">ì¡°íšŒ ì‹¤íŒ¨</p>';
    }
  }

  // êµ¬ë… ìƒíƒœ ì¡°íšŒ
  async function loadUserSubscriptionStatus(userId) {
    try {
      const response = await fetch(`/admin/api/users/${userId}/subscription-status`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
        }
      });

      const data = await response.json();
      const sub = data.subscription || {};
      const payments = data.payments || [];

      const summaryDiv = document.getElementById('subscriptionSummary');

      summaryDiv.innerHTML = `
        <div class="columns is-multiline">
          <div class="column is-6">
            <strong>í˜„ì¬ êµ¬ë… ìƒíƒœ:</strong> ${sub.status || 'ì—†ìŒ'}
          </div>
          <div class="column is-6">
            <strong>ë‹¤ìŒ ê²°ì œì¼:</strong> ${sub.next_billing_at ? new Date(sub.next_billing_at).toLocaleString('ko-KR') : '-'}
          </div>
          <div class="column is-6">
            <strong>ìµœê·¼ ê²°ì œ ê¸ˆì•¡:</strong> ${payments.length > 0 ? payments[0].amount.toLocaleString() + 'ì›' : '-'}
          </div>
          <div class="column is-6">
            <strong>ìë™ê²°ì œ ì—¬ë¶€:</strong> ${sub.status === 'active' ? '<span class="tag is-success">ON</span>' : '<span class="tag is-light">OFF</span>'}
          </div>
        </div>
      `;

    } catch (error) {
      console.error('êµ¬ë… ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
      document.getElementById('subscriptionSummary').innerHTML = 
        '<p class="has-text-danger">ì¡°íšŒ ì‹¤íŒ¨</p>';
    }
  }

  // ì˜ˆì•½ëœ í”„ë¡œëª¨ì…˜ ì¡°íšŒ
  async function loadUserPendingPromotions(userId) {
    try {
      const response = await fetch(`/admin/api/users/${userId}/pending-promotions`, {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
        }
      });

      const data = await response.json();
      const pending = data.pending || [];

      const listDiv = document.getElementById('pendingPromotionsList');

      if (pending.length === 0) {
        listDiv.innerHTML = '<p class="has-text-centered">ì˜ˆì•½ëœ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
      }

      listDiv.innerHTML = `
        <table class="table is-fullwidth is-narrow">
          <thead>
            <tr>
              <th>í”„ë¡œëª¨ì…˜ëª…</th>
              <th>ì˜ˆì•½ ì‹œê°</th>
              <th>ìƒíƒœ</th>
              <th>ì ìš© ì˜ˆì •</th>
            </tr>
          </thead>
          <tbody>
            ${pending.map(p => {
              let statusBadge = '';
              if (p.applied_at) {
                statusBadge = '<span class="tag is-success status-applied">ì ìš© ì™„ë£Œ</span>';
              } else {
                statusBadge = '<span class="tag is-warning status-reserved">ì˜ˆì•½ë¨</span>';
              }

              return `
                <tr>
                  <td>${p.promotion_name}</td>
                  <td>${new Date(p.created_at).toLocaleString('ko-KR')}</td>
                  <td>${statusBadge}</td>
                  <td>${p.applied_at ? new Date(p.applied_at).toLocaleString('ko-KR') : 'ë‹¤ìŒ ê²°ì œ ì‹œ'}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

    } catch (error) {
      console.error('ì˜ˆì•½ í”„ë¡œëª¨ì…˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
      document.getElementById('pendingPromotionsList').innerHTML = 
        '<p class="has-text-danger">ì¡°íšŒ ì‹¤íŒ¨</p>';
    }
  }

  // í• ë‹¹ ìê²© ì²´í¬
  function checkAssignmentEligibility(user) {
    const checkDiv = document.getElementById('assignmentEligibilityCheck');
    const assignButton = document.getElementById('singleAssignButton');

    if (!user.is_first_payment) {
      checkDiv.innerHTML = `
        <div class="notification is-danger is-light">
          <strong>âŒ í• ë‹¹ ë¶ˆê°€</strong><br>
          ì´ íšŒì›ì€ ì´ë¯¸ ê²°ì œ ì´ë ¥ì´ ìˆê±°ë‚˜, ê³¼ê±° í”„ë¡œëª¨ì…˜ í˜œíƒì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br>
          ì²« ê²°ì œ ì „ìš© í”„ë¡œëª¨ì…˜ì€ í• ë‹¹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
      `;
      assignButton.disabled = true;
      return;
    }

    checkDiv.innerHTML = `
      <div class="notification is-success is-light">
        <strong>âœ… í• ë‹¹ ê°€ëŠ¥</strong><br>
        ì´ íšŒì›ì€ ì²« ê²°ì œ ì˜ˆì • ê³ ê°ì…ë‹ˆë‹¤. í”„ë¡œëª¨ì…˜ì„ í• ë‹¹í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    `;
    assignButton.disabled = false;
  }

  // ê°œë³„ í• ë‹¹
  async function executeSingleAssign() {
    if (!currentUserDetail) {
      alert('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const promotionId = document.getElementById('singlePromotionSelect').value;
    const memo = document.getElementById('singleAssignMemo').value.trim();

    if (!promotionId) {
      alert('í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    if (!confirm(`${currentUserDetail.pharmacist_name}ë‹˜ì—ê²Œ í”„ë¡œëª¨ì…˜ì„ í• ë‹¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }

    try {
      const response = await fetch('/admin/api/assign-promotion', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          promotion_id: promotionId,
          user_ids: [currentUserDetail.user_id],
          memo: memo || null
        })
      });

      const result = await response.json();

      if (result.success) {
        alert('í”„ë¡œëª¨ì…˜ì´ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeUserDetailModal();
        await loadCandidatesList();
        await loadAssignmentList();
      } else {
        alert('í• ë‹¹ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }

    } catch (error) {
      console.error('ê°œë³„ í• ë‹¹ ì˜¤ë¥˜:', error);
      alert('í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ===========================
  // í• ë‹¹ ë‚´ì—­ ì¡°íšŒ
  // ===========================
  async function loadAssignmentList() {
    try {
      const response = await fetch('/admin/api/assign-promotion/assignments', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
        }
      });

      const data = await response.json();
      const tbody = document.getElementById('assignmentTableBody');

      if (!data.assignments || data.assignments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">í• ë‹¹ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }

      tbody.innerHTML = data.assignments.map(assign => {
        const user = assign.users || {};
        const promo = assign.subscription_promotions || {};

        let statusBadge = '';
        if (assign.applied_at) {
          statusBadge = '<span class="tag is-success status-applied">ì ìš© ì™„ë£Œ</span>';
        } else {
          statusBadge = '<span class="tag is-warning status-reserved">ì˜ˆì•½ë¨</span>';
        }

        let discountInfo = '';
        if (promo.discount_type === 'free') {
          discountInfo = `${promo.free_months}ê°œì›” ë¬´ë£Œ`;
        } else if (promo.discount_type === 'percent') {
          discountInfo = `${promo.discount_value}% í• ì¸`;
        } else if (promo.discount_type === 'amount') {
          discountInfo = `${promo.discount_value.toLocaleString()}ì› í• ì¸`;
        }

        const sourceBadge = assign.source === 'admin_assigned' 
          ? '<span class="tag is-info">ê´€ë¦¬ì</span>' 
          : (assign.source === 'referral' 
            ? '<span class="tag is-link">ì¶”ì²œì¸</span>' 
            : '<span class="tag is-light">ì‚¬ìš©ì</span>');

        const canCancel = !assign.applied_at;

        return `
          <tr>
            <td>
              <strong>${user.pharmacy_name || '(ì•Œ ìˆ˜ ì—†ìŒ)'}</strong><br>
              <small>${user.email || ''}</small>
            </td>
            <td>${promo.promotion_name || '(ì•Œ ìˆ˜ ì—†ìŒ)'}<br><small>${promo.promotion_code || ''}</small></td>
            <td>${discountInfo}</td>
            <td>${new Date(assign.created_at).toLocaleString('ko-KR')}</td>
            <td>${assign.applied_at ? new Date(assign.applied_at).toLocaleString('ko-KR') : '-'}</td>
            <td>${statusBadge}</td>
            <td>${sourceBadge}</td>
            <td>
              ${canCancel ? `
                <button class="button is-danger is-small" onclick="cancelAssignment('${assign.pending_id}')">
                  <span class="icon"><i class="fas fa-times"></i></span>
                </button>
              ` : '-'}
            </td>
          </tr>
        `;
      }).join('');

    } catch (error) {
      console.error('í• ë‹¹ ë‚´ì—­ ì¡°íšŒ ì˜¤ë¥˜:', error);
      document.getElementById('assignmentTableBody').innerHTML = 
        '<tr><td colspan="8" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
    }
  }

  async function cancelAssignment(pendingId) {
    if (!confirm('ì´ í• ë‹¹ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      const response = await fetch('/admin/api/assign-promotion/' + pendingId, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
        }
      });

      const result = await response.json();

      if (result.success) {
        alert('í• ë‹¹ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        await loadAssignmentList();
        await loadCandidatesList();
      } else {
        alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }

    } catch (error) {
      console.error('í• ë‹¹ ì·¨ì†Œ ì˜¤ë¥˜:', error);
      alert('ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // í˜ì´ì§€ ì´ˆê¸°í™”
  initPromotionAssignPage();
</script>
