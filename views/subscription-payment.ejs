<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµ¬ë… ê²°ì œ - PharmChecker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://js.tosspayments.com/v2/standard"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .payment-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      overflow: hidden;
    }
    .payment-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }
    .payment-header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .payment-content {
      padding: 40px;
    }
    .plan-summary {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .plan-summary h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 18px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      color: #34495e;
    }
    .summary-row.total {
      border-top: 2px solid #dee2e6;
      padding-top: 15px;
      margin-top: 15px;
      font-weight: 700;
      font-size: 20px;
      color: #667eea;
    }
    .payment-button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .payment-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    .payment-button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
    }
    .notice {
      margin-top: 20px;
      padding: 15px;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 5px;
      font-size: 14px;
      color: #856404;
      line-height: 1.6;
    }
    .promotion-notice {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
      border-left: 4px solid #4caf50;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
    }
    .promotion-notice h4 {
      margin: 0 0 10px 0;
      color: #2e7d32;
      font-size: 16px;
    }
    .promotion-notice p {
      margin: 5px 0;
      color: #33691e;
      font-size: 14px;
      line-height: 1.6;
    }
    .promotion-applied {
      background: #e8f5e9;
      padding: 10px;
      border-radius: 5px;
      margin: 5px 0;
    }
    /* í”„ë¡œëª¨ì…˜ ì„ íƒ ëª¨ë‹¬ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
      margin-bottom: 30px;
    }
    .modal-header h2 {
      color: #2c3e50;
      font-size: 24px;
      margin-bottom: 10px;
    }
    .modal-header p {
      color: #7f8c8d;
      font-size: 14px;
    }
    .promotion-list {
      margin-bottom: 30px;
    }
    .promotion-item {
      border: 2px solid #ecf0f1;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }
    .promotion-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    .promotion-item.selected {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .promotion-item input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    .promotion-item label {
      cursor: pointer;
      display: block;
      width: 100%;
    }
    .promotion-name {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    .promotion-desc {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    .promotion-discount {
      font-size: 20px;
      font-weight: 700;
      color: #27ae60;
    }
    .promotion-empty {
      text-align: center;
      padding: 40px 20px;
      color: #95a5a6;
    }
    .promotion-empty .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .modal-price-summary {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .modal-price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
      color: #34495e;
    }
    .modal-price-row.total {
      border-top: 2px solid #dee2e6;
      padding-top: 15px;
      margin-top: 15px;
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    .modal-button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .modal-button.cancel {
      background: #ecf0f1;
      color: #7f8c8d;
    }
    .modal-button.cancel:hover {
      background: #bdc3c7;
    }
    .modal-button.confirm {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .modal-button.confirm:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      color: #7f8c8d;
      text-decoration: none;
      font-size: 14px;
    }
    .back-link:hover {
      color: #667eea;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .loading.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="payment-container">
    <div class="payment-header">
      <h1>ğŸ’³ êµ¬ë… ê²°ì œ</h1>
      <p>ì•ˆì „í•œ í† ìŠ¤í˜ì´ë¨¼ì¸  ìë™ê²°ì œ</p>
    </div>

    <div class="payment-content">
      <div class="plan-summary">
        <h3>ğŸ“‹ ê²°ì œ ì •ë³´</h3>
        <div class="summary-row">
          <span>í”Œëœ</span>
          <span id="planName"><%= planName %></span>
        </div>
        <div class="summary-row">
          <span>ê²°ì œ ê¸ˆì•¡</span>
          <span id="planPrice"><%= originalPrice.toLocaleString() %>ì›/ì›”</span>
        </div>
        <div class="summary-row">
          <span>ê²°ì œ ì£¼ê¸°</span>
          <span>ë§¤ì›” ìë™ê²°ì œ</span>
        </div>
      </div>

      <div id="payment-method"></div>
      <div id="agreement"></div>

      <button id="payment-button" class="payment-button">
        ê²°ì œí•˜ê¸°
      </button>

      <div class="loading" id="loading">
        <p>ê²°ì œ ì²˜ë¦¬ ì¤‘...</p>
      </div>

      <div class="notice">
        âš ï¸ ì²« ë‹¬ì€ ì„ íƒí•˜ì‹  í”Œëœìœ¼ë¡œ ê³ ì •ë˜ë©°, ë‹¤ìŒ ë‹¬ë¶€í„° ì‹¤ì œ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ìë™ìœ¼ë¡œ í”Œëœì´ ì¡°ì •ë©ë‹ˆë‹¤.
      </div>

      <a href="/subscription/plans" class="back-link">â† í”Œëœ ë‹¤ì‹œ ì„ íƒí•˜ê¸°</a>
    </div>
  </div>

  <!-- í”„ë¡œëª¨ì…˜ ì„ íƒ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="promotionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ í”„ë¡œëª¨ì…˜ ì„ íƒ</h2>
        <p>ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œëª¨ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</p>
      </div>

      <div class="promotion-list" id="promotionList">
        <!-- í”„ë¡œëª¨ì…˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </div>

      <div class="modal-price-summary">
        <div class="modal-price-row">
          <span>í”Œëœ ì •ìƒê°€</span>
          <span id="modalOriginalPrice">-</span>
        </div>
        <div class="modal-price-row" id="modalDiscountRow" style="display: none;">
          <span>í”„ë¡œëª¨ì…˜ í• ì¸</span>
          <span id="modalDiscount" style="color: #e74c3c; font-weight: 600;">-</span>
        </div>
        <div class="modal-price-row total">
          <span>ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
          <span id="modalFinalPrice">-</span>
        </div>
      </div>

      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closePromotionModal()">ì·¨ì†Œ</button>
        <button class="modal-button confirm" onclick="confirmPromotion()">í™•ì¸</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    const supabaseClient = window.supabase.createClient(
      'https://gitbtujexmsjfixgeoha.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpdGJ0dWpleG1zamZpeGdlb2hhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0NzA5MDIsImV4cCI6MjA4MjA0NjkwMn0.BNN8hauH8NdHZ4vopW_CQ_iK9CR55nfp3JQwuTjrG48'
    );
    
    // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° (EJSë¡œ ì£¼ì…)
    const userId = '<%= userId %>';
    const planId = '<%= planId %>';
    const originalPrice = <%= originalPrice %>;
    const availablePromotions = <%- JSON.stringify(availablePromotions || []) %>;

    // ì„ íƒëœ í”„ë¡œëª¨ì…˜ ì •ë³´
    let selectedPromotion = null;
    let finalAmount = originalPrice;

    // í† ìŠ¤í˜ì´ë¨¼ì¸  ì´ˆê¸°í™”
    const clientKey = '<%= tossClientKey %>';
    const customerKey = userId;
    const tossPayments = TossPayments(clientKey);
    const payment = tossPayments.payment({ customerKey });

    // í”„ë¡œëª¨ì…˜ ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
    function openPromotionModal() {
      const modal = document.getElementById('promotionModal');
      const promotionList = document.getElementById('promotionList');
      
      // ëª¨ë‹¬ ê°€ê²© í‘œì‹œ
      document.getElementById('modalOriginalPrice').textContent = originalPrice.toLocaleString() + 'ì›';
      document.getElementById('modalFinalPrice').textContent = originalPrice.toLocaleString() + 'ì›';
      
      // í”„ë¡œëª¨ì…˜ ëª©ë¡ ë Œë”ë§
      promotionList.innerHTML = '';
      
      if (availablePromotions.length === 0) {
        // í”„ë¡œëª¨ì…˜ ì—†ìŒ
        promotionList.innerHTML = `
          <div class="promotion-empty">
            <div class="icon">ğŸ“­</div>
            <h3>ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œëª¨ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p style="margin-top: 10px;">ì •ìƒ ê¸ˆì•¡ìœ¼ë¡œ ê²°ì œê°€ ì§„í–‰ë©ë‹ˆë‹¤.</p>
          </div>
        `;
      } else {
        // í”„ë¡œëª¨ì…˜ ëª©ë¡
        availablePromotions.forEach((promo, index) => {
          const discountAmount = promo.discount_type === 'free' 
            ? originalPrice 
            : (promo.discount_type === 'percent' 
              ? Math.round(originalPrice * promo.discount_value / 100)
              : promo.discount_value);
          
          const finalPrice = Math.max(0, originalPrice - discountAmount);
          
          const promoHtml = `
            <div class="promotion-item" id="promo-${index}" onclick="selectPromotion(${index})">
              <input type="radio" name="promotion" id="radio-${index}" value="${index}">
              <label for="radio-${index}">
                <div class="promotion-name">${promo.promotion_name}</div>
                <div class="promotion-desc">${promo.referral_code ? 'ì½”ë“œ: ' + promo.referral_code : ''}</div>
                <div class="promotion-discount">
                  ${promo.discount_type === 'free' ? 'ì²« ' + promo.free_months + 'ê°œì›” ë¬´ë£Œ' : 
                    promo.discount_type === 'percent' ? promo.discount_value + '% í• ì¸' : 
                    discountAmount.toLocaleString() + 'ì› í• ì¸'}
                  â†’ <span style="color: #27ae60;">${finalPrice.toLocaleString()}ì›</span>
                </div>
              </label>
            </div>
          `;
          promotionList.innerHTML += promoHtml;
        });
      }
      
      modal.classList.add('active');
    }

    // í”„ë¡œëª¨ì…˜ ì„ íƒ
    function selectPromotion(index) {
      // ëª¨ë“  ì•„ì´í…œ ì„ íƒ í•´ì œ
      document.querySelectorAll('.promotion-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // ì„ íƒí•œ ì•„ì´í…œ í™œì„±í™”
      const selectedItem = document.getElementById(`promo-${index}`);
      const radio = document.getElementById(`radio-${index}`);
      if (selectedItem && radio) {
        selectedItem.classList.add('selected');
        radio.checked = true;
        
        // ì„ íƒí•œ í”„ë¡œëª¨ì…˜ ì •ë³´ ì €ì¥
        selectedPromotion = availablePromotions[index];
        
        // ìµœì¢… ê¸ˆì•¡ ê³„ì‚°
        const discountAmount = selectedPromotion.discount_type === 'free' 
          ? originalPrice 
          : (selectedPromotion.discount_type === 'percent' 
            ? Math.round(originalPrice * selectedPromotion.discount_value / 100)
            : selectedPromotion.discount_value);
        
        finalAmount = Math.max(0, originalPrice - discountAmount);
        
        // ëª¨ë‹¬ ê°€ê²© ì—…ë°ì´íŠ¸
        document.getElementById('modalDiscountRow').style.display = 'flex';
        document.getElementById('modalDiscount').textContent = '-' + discountAmount.toLocaleString() + 'ì›';
        document.getElementById('modalFinalPrice').textContent = finalAmount.toLocaleString() + 'ì›';
        document.getElementById('modalFinalPrice').style.color = finalAmount === 0 ? '#27ae60' : '#667eea';
      }
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closePromotionModal() {
      document.getElementById('promotionModal').classList.remove('active');
      // ì„ íƒ ì´ˆê¸°í™”
      selectedPromotion = null;
      finalAmount = originalPrice;
    }

    // í”„ë¡œëª¨ì…˜ í™•ì¸ ë° ê²°ì œ ì§„í–‰
    async function confirmPromotion() {
      const modal = document.getElementById('promotionModal');
      modal.classList.remove('active');
      
      // ë¡œë”© í‘œì‹œ
      document.getElementById('payment-button').disabled = true;
      document.getElementById('loading').classList.add('active');

      try {
        // Supabase ì„¸ì…˜ì—ì„œ access_token ê°€ì ¸ì˜¤ê¸°
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
          window.location.href = '/login';
          return;
        }
        
        const accessToken = session.access_token;
        
        // ìë™ê²°ì œ ì¹´ë“œ ë“±ë¡ ìš”ì²­ (ìµœì¢… ê¸ˆì•¡ + access_token ì „ë‹¬)
        await payment.requestBillingAuth({
          method: 'CARD',
          successUrl: window.location.origin + `/subscription/billing-success?planId=${planId}&userId=${userId}&amount=${finalAmount}&originalPrice=${originalPrice}&promotionId=${selectedPromotion ? selectedPromotion.promotion_id : ''}&referralCodeId=${selectedPromotion ? selectedPromotion.referral_code_id : ''}&access_token=${accessToken}`,
          failUrl: window.location.origin + '/subscription/payment-fail',
          customerEmail: localStorage.getItem('email'),
          customerName: localStorage.getItem('name'),
        });

      } catch (error) {
        console.error('ì¹´ë“œ ë“±ë¡ ìš”ì²­ ì‹¤íŒ¨:', error);
        alert('ì¹´ë“œ ë“±ë¡ ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        document.getElementById('payment-button').disabled = false;
        document.getElementById('loading').classList.remove('active');
      }
    }

    // ê²°ì œí•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ (ëª¨ë‹¬ ì—´ê¸°)
    document.getElementById('payment-button').addEventListener('click', function() {
      openPromotionModal();
    });
  </script>
</body>
</html>
