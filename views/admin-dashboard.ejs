<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmChecker ìš´ì˜ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background-color: #f5f5f5; }
    .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.08); }
    .sidebar {
      min-height: calc(100vh - 52px);
      background: white;
      border-right: 1px solid #dbdbdb;
      padding: 1.5rem 0;
    }
    .menu-label {
      padding: 0 1rem;
      text-transform: uppercase;
      font-size: 0.75rem;
      font-weight: 700;
      color: #7a7a7a;
    }
    .menu-list a {
      border-radius: 0;
      padding: 0.75rem 1.5rem;
    }
    .menu-list a.is-active {
      background-color: #3273dc;
      color: white;
    }
    .stat-card {
      background: white;
      border-radius: 6px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      margin-bottom: 1.5rem;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #3273dc;
    }
    .stat-label {
      color: #7a7a7a;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    .content-area {
      padding: 2rem;
    }
    .quick-action {
      transition: transform 0.2s;
    }
    .quick-action:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="navbar is-white" role="navigation">
    <div class="navbar-brand">
      <div class="navbar-item">
        <strong>ğŸ¥ PharmChecker ìš´ì˜ ëŒ€ì‹œë³´ë“œ</strong>
      </div>
    </div>
    
    <div class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            <i class="fas fa-user-shield"></i>
            <span id="adminName"><%= typeof adminName !== 'undefined' ? adminName : 'ê´€ë¦¬ì' %></span>
          </a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="columns is-gapless">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="column is-2 sidebar">
      <aside class="menu">
        <p class="menu-label">ë©”ì¸</p>
        <ul class="menu-list">
          <li><a class="is-active" onclick="window.location.reload()">
            <i class="fas fa-home"></i> ëŒ€ì‹œë³´ë“œ
          </a></li>
        </ul>

        <p class="menu-label">êµ¬ë… ê´€ë¦¬</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('users')">
            <i class="fas fa-users"></i> íšŒì› ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('subscriptions')">
            <i class="fas fa-credit-card"></i> êµ¬ë… í˜„í™©
          </a></li>
          <li><a onclick="loadPage('payments')">
            <i class="fas fa-receipt"></i> ê²°ì œ ë‚´ì—­
          </a></li>
        </ul>

        <p class="menu-label">í”„ë¡œëª¨ì…˜</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('promotions')">
            <i class="fas fa-gift"></i> í”„ë¡œëª¨ì…˜ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('referral-codes')">
            <i class="fas fa-ticket-alt"></i> ì¶”ì²œì¸ ì½”ë“œ
          </a></li>
          <li><a onclick="loadPage('assign-promotion')">
            <i class="fas fa-user-tag"></i> í”„ë¡œëª¨ì…˜ í• ë‹¹
          </a></li>
        </ul>

        <p class="menu-label">ì‹œìŠ¤í…œ</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('plans')">
            <i class="fas fa-layer-group"></i> í”Œëœ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('activity-logs')">
            <i class="fas fa-history"></i> í™œë™ ë¡œê·¸
          </a></li>
          <li><a onclick="loadPage('settings')">
            <i class="fas fa-cog"></i> ì„¤ì •
          </a></li>
        </ul>
      </aside>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="column content-area">
      <div id="mainContent">
        <!-- ëŒ€ì‹œë³´ë“œ í†µê³„ -->
        <h1 class="title">ëŒ€ì‹œë³´ë“œ</h1>
        
        <div class="columns is-multiline">
          <!-- í†µê³„ ì¹´ë“œë“¤ -->
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="totalUsers">-</div>
              <div class="stat-label">ì „ì²´ íšŒì›</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="activeSubscriptions">-</div>
              <div class="stat-label">í™œì„± êµ¬ë…</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="monthlyRevenue">-</div>
              <div class="stat-label">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="activePromotions">-</div>
              <div class="stat-label">í™œì„± í”„ë¡œëª¨ì…˜</div>
            </div>
          </div>
        </div>

        <!-- ë¹ ë¥¸ ì‘ì—… -->
        <h2 class="title is-4 mt-5">ë¹ ë¥¸ ì‘ì—…</h2>
        <div class="columns is-multiline">
          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('promotions')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-info">
                    <i class="fas fa-2x fa-gift"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">í”„ë¡œëª¨ì…˜ ìƒì„±</p>
                  <p class="subtitle is-6">ìƒˆë¡œìš´ í• ì¸/ë¬´ë£Œ í”„ë¡œëª¨ì…˜</p>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('assign-promotion')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-success">
                    <i class="fas fa-2x fa-user-tag"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">í”„ë¡œëª¨ì…˜ í• ë‹¹</p>
                  <p class="subtitle is-6">íšŒì›ì—ê²Œ í”„ë¡œëª¨ì…˜ ë¶€ì—¬</p>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('users')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-warning">
                    <i class="fas fa-2x fa-users"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">íšŒì› ì¡°íšŒ</p>
                  <p class="subtitle is-6">íšŒì› ì •ë³´ ë° êµ¬ë… ìƒíƒœ</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ìµœê·¼ í™œë™ -->
        <h2 class="title is-4 mt-5">ìµœê·¼ í™œë™</h2>
        <div class="box">
          <table class="table is-fullwidth is-hoverable">
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>í™œë™</th>
                <th>ëŒ€ìƒ</th>
                <th>ê´€ë¦¬ì</th>
              </tr>
            </thead>
            <tbody id="recentActivities">
              <tr>
                <td colspan="4" class="has-text-centered">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // URLì„ /adminìœ¼ë¡œ ë³€ê²½
    if (window.location.pathname !== '/admin') {
      window.history.replaceState(null, '', '/admin');
    }
    
    // ë¡œê·¸ì¸ í™•ì¸
    function checkAuth() {
      const sessionToken = localStorage.getItem('admin_session_token');
      if (!sessionToken) {
        window.location.href = '/admin';
        return;
      }
      loadAdminInfo();
    }

    // ê´€ë¦¬ì ì •ë³´ ë¡œë“œ
    async function loadAdminInfo() {
      try {
        // ì¿ í‚¤ì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        const cookies = document.cookie.split(';').reduce((acc, cookie) => {
          const trimmed = cookie.trim();
          const eqIndex = trimmed.indexOf('=');
          if (eqIndex > 0) {
            const key = trimmed.substring(0, eqIndex);
            const value = trimmed.substring(eqIndex + 1);
            acc[key] = value;
          }
          return acc;
        }, {});
        const token = cookies['admin_session_token'] || localStorage.getItem('admin_session_token');
        
        if (!token) {
          throw new Error('í† í° ì—†ìŒ');
        }
        
        // localStorageì—ë„ ì €ì¥ (í˜¸í™˜ì„±)
        localStorage.setItem('admin_session_token', token);
        
        const response = await fetch('/admin/api/me', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        if (!response.ok) {
          throw new Error('ì¸ì¦ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        document.getElementById('adminName').textContent = data.admin_name + ' (' + data.email + ')';
      } catch (error) {
        console.error('ê´€ë¦¬ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ëª¨ë“  ì„¸ì…˜ ì •ë³´ ì‚­ì œ
        localStorage.removeItem('admin_session_token');
        
        // ì¿ í‚¤ ì‚­ì œ
        const cookiesToDelete = [
          'admin_session_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
          'admin_session_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT',
          'admin_session_token=; domain=' + window.location.hostname + '; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
        ];
        cookiesToDelete.forEach(cookie => document.cookie = cookie);
        
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        window.location.href = '/admin';
      }
    }

    // ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ
    async function loadDashboardStats() {
      try {
        const token = localStorage.getItem('admin_session_token');
        console.log('í†µê³„ API í˜¸ì¶œ ì‹œì‘, í† í°:', token ? 'ì¡´ì¬' : 'ì—†ìŒ');
        
        const response = await fetch('/admin/api/dashboard/stats', {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        
        console.log('í†µê³„ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
        
        if (!response.ok) {
          // ì¸ì¦ ì˜¤ë¥˜ë©´ ì„¸ì…˜ ë§Œë£Œë¡œ ì²˜ë¦¬
          if (response.status === 401 || response.status === 403) {
            localStorage.removeItem('admin_session_token');
            const cookiesToDelete = [
              'admin_session_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
              'admin_session_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT'
            ];
            cookiesToDelete.forEach(cookie => document.cookie = cookie);
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/admin';
            return;
          }
          
          const errorText = await response.text();
          console.error('í†µê³„ API ì˜¤ë¥˜:', errorText);
          throw new Error('í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: ' + response.status);
        }
        
        const stats = await response.json();
        
        console.log('ëŒ€ì‹œë³´ë“œ í†µê³„:', stats);
        
        document.getElementById('totalUsers').textContent = stats.totalUsers.toLocaleString();
        document.getElementById('activeSubscriptions').textContent = stats.activeSubscriptions.toLocaleString();
        document.getElementById('monthlyRevenue').textContent = `${(stats.monthlyRevenue / 10000).toFixed(0)}ë§Œì›`;
        document.getElementById('activePromotions').textContent = stats.activePromotions.toLocaleString();
        
      } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('totalUsers').textContent = 'ì˜¤ë¥˜';
        document.getElementById('activeSubscriptions').textContent = 'ì˜¤ë¥˜';
        document.getElementById('monthlyRevenue').textContent = 'ì˜¤ë¥˜';
        document.getElementById('activePromotions').textContent = 'ì˜¤ë¥˜';
      }
    }

    // ìµœê·¼ í™œë™ ë¡œë“œ
    async function loadRecentActivities() {
      try {
        const response = await fetch('/admin/api/activities/recent', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const activities = await response.json();
        const tbody = document.getElementById('recentActivities');
        
        if (activities.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = activities.map(act => `
          <tr>
            <td>${new Date(act.created_at).toLocaleString('ko-KR')}</td>
            <td><span class="tag">${act.action_type}</span></td>
            <td>${act.target_type || '-'}</td>
            <td>${act.admin_name}</td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('í™œë™ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // í˜ì´ì§€ ì „í™˜
    function loadPage(page) {
      // ë©”ë‰´ í™œì„±í™” ìƒíƒœ ë³€ê²½
      document.querySelectorAll('.menu-list a').forEach(a => a.classList.remove('is-active'));
      event.target.closest('a').classList.add('is-active');
      
      if (page === 'dashboard') {
        // ëŒ€ì‹œë³´ë“œëŠ” í˜„ì¬ í˜ì´ì§€ ë¦¬ë¡œë“œ
        location.reload();
        return;
      }
      
      if (page === 'users') {
        loadUsersPage();
        return;
      }
      
      // TODO: í˜ì´ì§€ë³„ ì»¨í…ì¸  ë¡œë“œ
      alert(`${page} í˜ì´ì§€ ê°œë°œ ì˜ˆì •`);
    }
    
    // íšŒì› ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ
    async function loadUsersPage() {
      const mainContent = document.getElementById('mainContent');
      
      mainContent.innerHTML = `
        <h1 class="title">íšŒì› ê´€ë¦¬</h1>
        
        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="box">
          <!-- ì²« ë²ˆì§¸ í–‰: ì´ë¦„, ì´ë©”ì¼ ê²€ìƒ‰ -->
          <div class="columns">
            <div class="column is-3">
              <div class="field">
                <label class="label">ì•½ì‚¬ëª… ê²€ìƒ‰</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" id="nameSearch" placeholder="ì•½ì‚¬ëª… ì…ë ¥">
                  <span class="icon is-small is-left">
                    <i class="fas fa-user"></i>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="column is-3">
              <div class="field">
                <label class="label">ì´ë©”ì¼ ê²€ìƒ‰</label>
                <div class="control has-icons-left">
                  <input class="input" type="text" id="emailSearch" placeholder="ì´ë©”ì¼ ì…ë ¥">
                  <span class="icon is-small is-left">
                    <i class="fas fa-envelope"></i>
                  </span>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">êµ¬ë… ìƒíƒœ</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="subscriptionFilter">
                      <option value="">ì „ì²´</option>
                      <option value="active">í™œì„±</option>
                      <option value="cancelled">ì·¨ì†Œë¨</option>
                      <option value="none">ì—†ìŒ</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">ê³„ì • ìƒíƒœ</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="accountFilter">
                      <option value="">ì „ì²´</option>
                      <option value="active">í™œì„±</option>
                      <option value="deleted">íƒˆí‡´</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="column is-2">
              <div class="field">
                <label class="label">&nbsp;</label>
                <button class="button is-primary is-fullwidth" onclick="searchUsers()">
                  <i class="fas fa-search"></i> ê²€ìƒ‰
                </button>
              </div>
            </div>
          </div>
          
          <!-- ë‘ ë²ˆì§¸ í–‰: ê¸°ê°„ í•„í„° -->
          <div class="columns">
            <div class="column is-3">
              <div class="field">
                <label class="label">ê¸°ê°„ ì‹œì‘ì¼</label>
                <div class="control">
                  <input class="input" type="date" id="startDate">
                </div>
              </div>
            </div>
            
            <div class="column is-3">
              <div class="field">
                <label class="label">ê¸°ê°„ ì¢…ë£Œì¼</label>
                <div class="control">
                  <input class="input" type="date" id="endDate">
                </div>
              </div>
            </div>
            
            <div class="column is-6">
              <div class="field">
                <label class="label">ê¸°ê°„ í•„í„° ì•ˆë‚´</label>
                <p class="help">
                  <i class="fas fa-info-circle"></i> 
                  íƒˆí‡´ íšŒì›: íƒˆí‡´ì¼ ê¸°ì¤€ / í™œì„± êµ¬ë…: êµ¬ë… ê¸°ê°„ ë‚´ í¬í•¨ / ê¸°íƒ€: ê°€ì…ì¼ ê¸°ì¤€
                </p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- íšŒì› ëª©ë¡ í…Œì´ë¸” -->
        <div class="box">
          <div class="table-container">
            <table class="table is-fullwidth is-hoverable is-narrow" style="font-size: 0.85rem;">
              <thead>
                <tr>
                  <th>ì´ë©”ì¼</th>
                  <th>ì•½ì‚¬ëª…</th>
                  <th>ì•½êµ­ëª…</th>
                  <th>ì „í™”ë²ˆí˜¸</th>
                  <th>êµ¬ë… ìƒíƒœ</th>
                  <th>í”Œëœ</th>
                  <th>ë§ˆì§€ë§‰ ê²°ì œì¼</th>
                  <th>ë‹¤ìŒ ê²°ì œì¼</th>
                  <th>í”„ë¡œëª¨ì…˜</th>
                  <th style="min-width: 150px;">ë¹„ê³ </th>
                  <th>ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <tr>
                  <td colspan="11" class="has-text-centered">ë¡œë”© ì¤‘...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
          <nav class="pagination is-centered" role="navigation" id="pagination">
            <a class="pagination-previous" id="prevPage">ì´ì „</a>
            <a class="pagination-next" id="nextPage">ë‹¤ìŒ</a>
            <ul class="pagination-list" id="pageNumbers"></ul>
          </nav>
      `;
      
      // íšŒì› ëª©ë¡ ë¡œë“œ
      await fetchUsers();
    }
    
    // ì „ì—­ ë³€ìˆ˜
    let currentPage = 1;
    let currentName = '';
    let currentEmail = '';
    let currentStartDate = '';
    let currentEndDate = '';
    let currentSubFilter = '';
    let currentAccFilter = '';
    
    // íšŒì› ê²€ìƒ‰
    function searchUsers() {
      currentPage = 1;
      currentName = document.getElementById('nameSearch').value;
      currentEmail = document.getElementById('emailSearch').value;
      currentStartDate = document.getElementById('startDate').value;
      currentEndDate = document.getElementById('endDate').value;
      currentSubFilter = document.getElementById('subscriptionFilter').value;
      currentAccFilter = document.getElementById('accountFilter').value;
      fetchUsers();
    }
    
    // íšŒì› ëª©ë¡ ì¡°íšŒ
    async function fetchUsers(page = 1) {
      currentPage = page;
      
      try {
        const params = new URLSearchParams({
          page: currentPage,
          limit: 20,
          name: currentName,
          email: currentEmail,
          startDate: currentStartDate,
          endDate: currentEndDate,
          subscriptionStatus: currentSubFilter,
          accountStatus: currentAccFilter
        });
        
        const response = await fetch('/admin/api/users?' + params, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token')
          }
        });
        
        const data = await response.json();
        
        // í…Œì´ë¸” ë Œë”ë§
        const tbody = document.getElementById('usersTableBody');
        
        if (!data.users || data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="11" class="has-text-centered">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.users.map(user => {
          const subscriptionTag = user.subscription 
            ? '<span class="tag ' + (user.subscription.status === 'active' ? 'is-success' : 'is-warning') + '">' + (user.subscription.status === 'active' ? 'í™œì„±' : 'ì·¨ì†Œë¨') + '</span>'
            : '<span class="tag is-light">ì—†ìŒ</span>';
          
          const accountTag = user.is_deleted 
            ? '<span class="tag is-danger">íƒˆí‡´</span>' 
            : (user.is_active ? '<span class="tag is-success">í™œì„±</span>' : '<span class="tag is-warning">ë¹„í™œì„±</span>');
          
          const lastPaymentDate = user.last_payment 
            ? new Date(user.last_payment.date).toLocaleDateString('ko-KR')
            : '-';
          
          const nextBillingDate = user.subscription?.next_billing_at
            ? new Date(user.subscription.next_billing_at).toLocaleDateString('ko-KR')
            : '-';
          
          const promotionInfo = user.active_promotions && user.active_promotions.length > 0
            ? user.active_promotions.map(p => {
                if (p.promotion_type === 'discount') {
                  return p.discount_rate + '% í• ì¸';
                } else if (p.promotion_type === 'free') {
                  return p.free_months + 'ê°œì›” ë¬´ë£Œ';
                }
                return p.promotion_type;
              }).join(', ')
            : '-';
          
          return '<tr>'+
            '<td>' + user.email + '</td>'+
            '<td>' + user.pharmacist_name + '</td>'+
            '<td>' + user.pharmacy_name + '</td>'+
            '<td>' + (user.pharmacist_phone || '-') + '</td>'+
            '<td>' + subscriptionTag + '</td>'+
            '<td>' + (user.subscription?.plan_name || '-') + '</td>'+
            '<td>' + lastPaymentDate + '</td>'+
            '<td>' + nextBillingDate + '</td>'+
            '<td style="font-size: 0.75rem;">' + promotionInfo + '</td>'+
            '<td>'+
              '<input type="text" class="input is-small" ' +
              'value="' + (user.latest_remarks || '') + '" ' +
              'onblur="updateUserRemarks(\'' + user.user_id + '\', this.value)" ' +
              'placeholder="ë¹„ê³  ì…ë ¥..." ' +
              'title="' + (user.full_memo ? 'ë©”ëª¨: ' + user.full_memo.substring(0, 100) : 'ë©”ëª¨ ì—†ìŒ') + '">'+
            '</td>'+
            '<td>' + accountTag + '</td>'+
          '</tr>';
        }).join('');
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
        renderPagination(data.page, data.totalPages);
        
      } catch (error) {
        console.error('íšŒì› ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        document.getElementById('usersTableBody').innerHTML = 
          '<tr><td colspan="11" class="has-text-centered has-text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</td></tr>';
      }
    }
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    function renderPagination(currentPage, totalPages) {
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const pageNumbers = document.getElementById('pageNumbers');
      
      // ì´ì „/ë‹¤ìŒ ë²„íŠ¼
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      
      prevBtn.onclick = () => currentPage > 1 && fetchUsers(currentPage - 1);
      nextBtn.onclick = () => currentPage < totalPages && fetchUsers(currentPage + 1);
      
      // í˜ì´ì§€ ë²ˆí˜¸
      let pages = [];
      const maxPages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);
      
      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        pages.push(
          '<li>' +
            '<a class="pagination-link ' + (i === currentPage ? 'is-current' : '') + '" ' +
               'onclick="fetchUsers(' + i + ')">' + i + '</a>' +
          '</li>'
        );
      }
      
      pageNumbers.innerHTML = pages.join('');
    }
    
    // íšŒì› ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
    function viewUserDetail(userId) {
      alert('íšŒì› ìƒì„¸ í˜ì´ì§€ ê°œë°œ ì˜ˆì •\nUser ID: ' + userId);
      // TODO: ìƒì„¸ í˜ì´ì§€ êµ¬í˜„
    }
    
    // íšŒì› ë¹„ê³  ì—…ë°ì´íŠ¸ (admin_user_memos.remarks ì‚¬ìš©)
    async function updateUserRemarks(userId, remarksText) {
      try {
        const response = await fetch('/admin/api/users/' + userId + '/memos', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('admin_session_token'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ remarks: remarksText })
        });
        
        if (!response.ok) {
          throw new Error('ë¹„ê³  ì €ì¥ ì‹¤íŒ¨');
        }
        
        const result = await response.json();
        console.log('ë¹„ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤:', result);
      } catch (error) {
        console.error('ë¹„ê³  ì €ì¥ ì˜¤ë¥˜:', error);
        alert('ë¹„ê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë¡œê·¸ì•„ì›ƒ
    async function logout() {
      if (!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      // ë¡œë”© í‘œì‹œ
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¡œê·¸ì•„ì›ƒ ì¤‘...';
        logoutBtn.style.pointerEvents = 'none';
      }
      
      try {
        // ë¡œê·¸ì•„ì›ƒ í™œë™ ë¡œê·¸ ê¸°ë¡
        await fetch('/admin/api/logout', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('admin_session_token')}`,
            'Content-Type': 'application/json'
          }
        });
      } catch (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
      }
      
      // í† í° ì‚­ì œ (localStorage)
      localStorage.removeItem('admin_session_token');
      
      // í† í° ì‚­ì œ (ì¿ í‚¤ - ëª¨ë“  ê²½ë¡œì™€ ë„ë©”ì¸ ì¡°í•©)
      const cookiesToDelete = [
        'admin_session_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; path=/admin; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=localhost; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=.localhost; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT',
        'admin_session_token=; domain=' + window.location.hostname + '; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'
      ];
      
      cookiesToDelete.forEach(cookie => {
        document.cookie = cookie;
      });
      
      // ì™„ì „íˆ ì‚­ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
      console.log('ë¡œê·¸ì•„ì›ƒ í›„ ì¿ í‚¤:', document.cookie);
      
      // /adminìœ¼ë¡œ ì´ë™ (ë¡œê·¸ì¸ í˜ì´ì§€ ìë™ ë¡œë“œ)
      window.location.href = '/admin';
    }

    // ì´ˆê¸°í™” - ì¦‰ì‹œ ì‹¤í–‰
    console.log('ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹œì‘');
    
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    window.addEventListener('load', function() {
      console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        console.log('ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë°œê²¬, ì´ë²¤íŠ¸ ë°”ì¸ë”©');
        logoutBtn.addEventListener('click', logout);
      } else {
        console.error('ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      }
    });
    
    // ì¸ì¦ ì²´í¬ ë° ë°ì´í„° ë¡œë“œ - ì¦‰ì‹œ ì‹¤í–‰
    console.log('checkAuth í˜¸ì¶œ');
    checkAuth();
    console.log('loadDashboardStats í˜¸ì¶œ');
    loadDashboardStats();
    console.log('loadRecentActivities í˜¸ì¶œ');
    loadRecentActivities();
  </script>
</body>
</html>
