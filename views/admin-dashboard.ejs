<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PharmChecker ìš´ì˜ ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { background-color: #f5f5f5; }
    .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.08); }
    .sidebar {
      min-height: calc(100vh - 52px);
      background: white;
      border-right: 1px solid #dbdbdb;
      padding: 1.5rem 0;
    }
    .menu-label {
      padding: 0 1rem;
      text-transform: uppercase;
      font-size: 0.75rem;
      font-weight: 700;
      color: #7a7a7a;
    }
    .menu-list a {
      border-radius: 0;
      padding: 0.75rem 1.5rem;
    }
    .menu-list a.is-active {
      background-color: #3273dc;
      color: white;
    }
    .stat-card {
      background: white;
      border-radius: 6px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
      margin-bottom: 1.5rem;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #3273dc;
    }
    .stat-label {
      color: #7a7a7a;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    .content-area {
      padding: 2rem;
    }
    .quick-action {
      transition: transform 0.2s;
    }
    .quick-action:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="navbar is-white" role="navigation">
    <div class="navbar-brand">
      <div class="navbar-item">
        <strong>ğŸ¥ PharmChecker ìš´ì˜ ëŒ€ì‹œë³´ë“œ</strong>
      </div>
    </div>
    
    <div class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            <i class="fas fa-user-shield"></i>
            <span id="adminName">ê´€ë¦¬ì</span>
          </a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" onclick="logout()">
              <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="columns is-gapless">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="column is-2 sidebar">
      <aside class="menu">
        <p class="menu-label">ë©”ì¸</p>
        <ul class="menu-list">
          <li><a class="is-active" onclick="loadPage('dashboard')">
            <i class="fas fa-home"></i> ëŒ€ì‹œë³´ë“œ
          </a></li>
        </ul>

        <p class="menu-label">êµ¬ë… ê´€ë¦¬</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('users')">
            <i class="fas fa-users"></i> íšŒì› ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('subscriptions')">
            <i class="fas fa-credit-card"></i> êµ¬ë… í˜„í™©
          </a></li>
          <li><a onclick="loadPage('payments')">
            <i class="fas fa-receipt"></i> ê²°ì œ ë‚´ì—­
          </a></li>
        </ul>

        <p class="menu-label">í”„ë¡œëª¨ì…˜</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('promotions')">
            <i class="fas fa-gift"></i> í”„ë¡œëª¨ì…˜ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('referral-codes')">
            <i class="fas fa-ticket-alt"></i> ì¶”ì²œì¸ ì½”ë“œ
          </a></li>
          <li><a onclick="loadPage('assign-promotion')">
            <i class="fas fa-user-tag"></i> í”„ë¡œëª¨ì…˜ í• ë‹¹
          </a></li>
        </ul>

        <p class="menu-label">ì‹œìŠ¤í…œ</p>
        <ul class="menu-list">
          <li><a onclick="loadPage('plans')">
            <i class="fas fa-layer-group"></i> í”Œëœ ê´€ë¦¬
          </a></li>
          <li><a onclick="loadPage('activity-logs')">
            <i class="fas fa-history"></i> í™œë™ ë¡œê·¸
          </a></li>
          <li><a onclick="loadPage('settings')">
            <i class="fas fa-cog"></i> ì„¤ì •
          </a></li>
        </ul>
      </aside>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="column content-area">
      <div id="mainContent">
        <!-- ëŒ€ì‹œë³´ë“œ í†µê³„ -->
        <h1 class="title">ëŒ€ì‹œë³´ë“œ</h1>
        
        <div class="columns is-multiline">
          <!-- í†µê³„ ì¹´ë“œë“¤ -->
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="totalUsers">-</div>
              <div class="stat-label">ì „ì²´ íšŒì›</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="activeSubscriptions">-</div>
              <div class="stat-label">í™œì„± êµ¬ë…</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="monthlyRevenue">-</div>
              <div class="stat-label">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
            </div>
          </div>
          
          <div class="column is-3">
            <div class="stat-card">
              <div class="stat-number" id="activePromotions">-</div>
              <div class="stat-label">í™œì„± í”„ë¡œëª¨ì…˜</div>
            </div>
          </div>
        </div>

        <!-- ë¹ ë¥¸ ì‘ì—… -->
        <h2 class="title is-4 mt-5">ë¹ ë¥¸ ì‘ì—…</h2>
        <div class="columns is-multiline">
          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('promotions')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-info">
                    <i class="fas fa-2x fa-gift"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">í”„ë¡œëª¨ì…˜ ìƒì„±</p>
                  <p class="subtitle is-6">ìƒˆë¡œìš´ í• ì¸/ë¬´ë£Œ í”„ë¡œëª¨ì…˜</p>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('assign-promotion')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-success">
                    <i class="fas fa-2x fa-user-tag"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">í”„ë¡œëª¨ì…˜ í• ë‹¹</p>
                  <p class="subtitle is-6">íšŒì›ì—ê²Œ í”„ë¡œëª¨ì…˜ ë¶€ì—¬</p>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-4">
            <div class="box quick-action" onclick="loadPage('users')">
              <div class="media">
                <div class="media-left">
                  <span class="icon is-large has-text-warning">
                    <i class="fas fa-2x fa-users"></i>
                  </span>
                </div>
                <div class="media-content">
                  <p class="title is-5">íšŒì› ì¡°íšŒ</p>
                  <p class="subtitle is-6">íšŒì› ì •ë³´ ë° êµ¬ë… ìƒíƒœ</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ìµœê·¼ í™œë™ -->
        <h2 class="title is-4 mt-5">ìµœê·¼ í™œë™</h2>
        <div class="box">
          <table class="table is-fullwidth is-hoverable">
            <thead>
              <tr>
                <th>ì‹œê°„</th>
                <th>í™œë™</th>
                <th>ëŒ€ìƒ</th>
                <th>ê´€ë¦¬ì</th>
              </tr>
            </thead>
            <tbody id="recentActivities">
              <tr>
                <td colspan="4" class="has-text-centered">ë¡œë”© ì¤‘...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ë¡œê·¸ì¸ í™•ì¸
    function checkAuth() {
      const sessionToken = localStorage.getItem('admin_session_token');
      if (!sessionToken) {
        window.location.href = '/ops-dashboard/login';
        return;
      }
      loadAdminInfo();
    }

    // ê´€ë¦¬ì ì •ë³´ ë¡œë“œ
    async function loadAdminInfo() {
      try {
        const response = await fetch('/api/admin/me', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('admin_session_token')}`
          }
        });
        
        if (!response.ok) {
          throw new Error('ì¸ì¦ ì‹¤íŒ¨');
        }
        
        const data = await response.json();
        document.getElementById('adminName').textContent = data.admin_name;
      } catch (error) {
        console.error('ê´€ë¦¬ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        logout();
      }
    }

    // ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ
    async function loadDashboardStats() {
      try {
        const response = await fetch('/api/admin/dashboard/stats', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('admin_session_token')}`
          }
        });
        
        const stats = await response.json();
        
        document.getElementById('totalUsers').textContent = stats.totalUsers.toLocaleString();
        document.getElementById('activeSubscriptions').textContent = stats.activeSubscriptions.toLocaleString();
        document.getElementById('monthlyRevenue').textContent = `${(stats.monthlyRevenue / 10000).toFixed(0)}ë§Œì›`;
        document.getElementById('activePromotions').textContent = stats.activePromotions.toLocaleString();
        
      } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ìµœê·¼ í™œë™ ë¡œë“œ
    async function loadRecentActivities() {
      try {
        const response = await fetch('/api/admin/activities/recent', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('admin_session_token')}`
          }
        });
        
        const activities = await response.json();
        const tbody = document.getElementById('recentActivities');
        
        if (activities.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
          return;
        }
        
        tbody.innerHTML = activities.map(act => `
          <tr>
            <td>${new Date(act.created_at).toLocaleString('ko-KR')}</td>
            <td><span class="tag">${act.action_type}</span></td>
            <td>${act.target_type || '-'}</td>
            <td>${act.admin_name}</td>
          </tr>
        `).join('');
        
      } catch (error) {
        console.error('í™œë™ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // í˜ì´ì§€ ì „í™˜
    function loadPage(page) {
      // ë©”ë‰´ í™œì„±í™” ìƒíƒœ ë³€ê²½
      document.querySelectorAll('.menu-list a').forEach(a => a.classList.remove('is-active'));
      event.target.closest('a').classList.add('is-active');
      
      // TODO: í˜ì´ì§€ë³„ ì»¨í…ì¸  ë¡œë“œ
      alert(`${page} í˜ì´ì§€ ê°œë°œ ì˜ˆì •`);
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      localStorage.removeItem('admin_session_token');
      window.location.href = '/ops-dashboard/login';
    }

    // ì´ˆê¸°í™”
    checkAuth();
    loadDashboardStats();
    loadRecentActivities();
  </script>
</body>
</html>
