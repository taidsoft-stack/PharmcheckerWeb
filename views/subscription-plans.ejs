<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµ¬ë… í”Œëœ ì„ íƒ - PharmChecker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    /* í—¤ë” ê³µí†µ ìŠ¤íƒ€ì¼ */
    .header-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      padding: 12px 0;
    }
    .header-nav .header-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: #191f28;
      cursor: pointer;
      text-decoration: none;
    }
    .logo:hover {
      color: #667eea;
    }
    .user-profile {
      position: relative;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      border-radius: 24px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .user-info:hover {
      background-color: #f8f9fa;
    }
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    .user-name {
      font-size: 15px;
      font-weight: 500;
      color: #191f28;
    }
    .dropdown-arrow {
      width: 0;
      height: 0;
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-top: 5px solid #6b7684;
      transition: transform 0.2s;
    }
    .user-info.active .dropdown-arrow {
      transform: rotate(180deg);
    }
    .dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 9999;
    }
    .dropdown-menu.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      display: block;
    }
    .dropdown-item {
      padding: 14px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    .dropdown-item:first-child {
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    .dropdown-item:last-child {
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      border-bottom: none;
    }
    .dropdown-item:hover {
      background-color: #f8f9fa;
    }
    .dropdown-item.logout {
      color: #e74c3c;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 100px 20px 40px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      color: white;
      margin-bottom: 50px;
    }
    .header h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }
    .header p {
      font-size: 18px;
      opacity: 0.9;
    }
    .plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }
    .plan-card {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      position: relative;
    }
    .plan-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    .plan-card.recommended {
      border: 3px solid #667eea;
    }
    .plan-card.recommended::before {
      content: 'ì¶”ì²œ';
      position: absolute;
      top: -15px;
      right: 20px;
      background: #667eea;
      color: white;
      padding: 5px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }
    .plan-name {
      font-size: 28px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .plan-price {
      font-size: 42px;
      font-weight: 800;
      color: #667eea;
      margin-bottom: 5px;
    }
    .plan-price span {
      font-size: 18px;
      color: #7f8c8d;
      font-weight: 400;
    }
    .plan-limit {
      font-size: 16px;
      color: #7f8c8d;
      margin-bottom: 30px;
    }
    .plan-features {
      list-style: none;
      margin-bottom: 30px;
    }
    .plan-features li {
      padding: 10px 0;
      color: #34495e;
      border-bottom: 1px solid #ecf0f1;
    }
    .plan-features li:before {
      content: 'âœ“';
      color: #27ae60;
      font-weight: bold;
      margin-right: 10px;
    }
    .select-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .select-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .notice {
      background: white;
      border-radius: 15px;
      padding: 25px;
      margin-top: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    .notice h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 18px;
    }
    .notice ul {
      list-style: none;
      color: #7f8c8d;
      line-height: 1.8;
    }
    .notice li:before {
      content: 'â€¢';
      color: #667eea;
      font-weight: bold;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="header-nav">
    <div class="header-container">
      <a href="/pharmchecker" class="logo">TAID SOFT</a>
      <div class="user-profile">
        <div class="user-info" onclick="toggleDropdown()">
          <div class="user-avatar" id="userAvatar">
            <span id="userInitial">U</span>
          </div>
          <span class="user-name" id="userName">ê²ŒìŠ¤íŠ¸</span>
          <div class="dropdown-arrow"></div>
        </div>
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-item" onclick="window.location.href='/my-subscription'">
            <span>ğŸ“‹</span>
            <span>ë‚´ êµ¬ë… ì •ë³´</span>
          </div>
          <div class="dropdown-item" onclick="window.location.href='/payment-history'">
            <span>ğŸ’³</span>
            <span>ê²°ì œ ë‚´ì—­</span>
          </div>
          <div class="dropdown-item" onclick="viewProfile()">
            <span>ğŸ‘¤</span>
            <span>í”„ë¡œí•„ ë³´ê¸°</span>
          </div>
          <div class="dropdown-item logout" onclick="logout()">
            <span>ğŸšª</span>
            <span>ë¡œê·¸ì•„ì›ƒ</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="header">
      <h1>ğŸ’Š PharmChecker</h1>
      <p>ì•½êµ­ì— ë”± ë§ëŠ” í”Œëœì„ ì„ íƒí•˜ì„¸ìš”</p>
    </div>

    <div class="plans-grid" id="plansGrid">
      <!-- í”Œëœ ì¹´ë“œëŠ” ì„œë²„ì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>

    <div class="notice">
      <h3>ğŸ“Œ ì•ˆë‚´ì‚¬í•­</h3>
      <ul>
        <li>ì²« ë‹¬ì€ ì„ íƒí•˜ì‹  í”Œëœìœ¼ë¡œ ê³ ì •ë˜ë©°, ì‚¬ìš©ëŸ‰ ì´ˆê³¼ ì‹œì—ë„ ì¶”ê°€ ìš”ê¸ˆì´ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
        <li>ë‘ ë²ˆì§¸ ë‹¬ë¶€í„°ëŠ” ì‹¤ì œ ì‚¬ìš©ëŸ‰ì„ ê¸°ì¤€ìœ¼ë¡œ ìë™ìœ¼ë¡œ í”Œëœì´ ê²°ì •ë©ë‹ˆë‹¤.</li>
        <li>ê²°ì œëŠ” ë§¤ì›” ìë™ìœ¼ë¡œ ì´ë£¨ì–´ì§€ë©°, ì–¸ì œë“ ì§€ í•´ì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
        <li>í† ìŠ¤í˜ì´ë¨¼ì¸  ìë™ê²°ì œë¡œ ì•ˆì „í•˜ê²Œ ê´€ë¦¬ë©ë‹ˆë‹¤.</li>
      </ul>
    </div>
  </div>

  <script>
    // ë“œë¡­ë‹¤ìš´ í† ê¸€
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownMenu');
      const userInfo = document.querySelector('.user-info');
      
      dropdown.classList.toggle('active');
      userInfo.classList.toggle('active');
    }
    
    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', function(event) {
      const userProfile = document.querySelector('.user-profile');
      const dropdown = document.getElementById('dropdownMenu');
      const userInfo = document.querySelector('.user-info');
      
      if (userProfile && !userProfile.contains(event.target)) {
        dropdown.classList.remove('active');
        userInfo.classList.remove('active');
      }
    });
    
    // í”„ë¡œí•„ ë³´ê¸°
    function viewProfile() {
      const userName = localStorage.getItem('name');
      const userEmail = localStorage.getItem('email');
      const pharmacyName = localStorage.getItem('pharmacy_name');
      
      if (userName) {
        let profileInfo = `í”„ë¡œí•„ ì •ë³´\n\nì´ë¦„: ${userName}\nì´ë©”ì¼: ${userEmail}`;
        if (pharmacyName) {
          profileInfo += `\nì•½êµ­ëª…: ${pharmacyName}`;
        }
        alert(profileInfo);
      }
    }
    
    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        localStorage.clear();
        window.location.href = '/login';
      }
    }
    
    // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('name');
    if (!userId) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      window.location.href = '/login';
    } else {
      document.getElementById('userName').textContent = (userName || 'ê²ŒìŠ¤íŠ¸') + 'ë‹˜';
      document.getElementById('userInitial').textContent = (userName || 'G').charAt(0).toUpperCase();
    }

    // í”Œëœ ë°ì´í„° ë¡œë“œ
    async function loadPlans() {
      try {
        const response = await fetch('/api/subscription/plans');
        const result = await response.json();

        if (result.success && result.data) {
          renderPlans(result.data);
        } else {
          alert('í”Œëœ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('í”Œëœ ë¡œë“œ ì—ëŸ¬:', error);
        alert('í”Œëœ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í”Œëœ ì¹´ë“œ ë Œë”ë§
    function renderPlans(plans) {
      const plansGrid = document.getElementById('plansGrid');
      plansGrid.innerHTML = '';

      plans.forEach((plan, index) => {
        const card = document.createElement('div');
        card.className = 'plan-card' + (index === 0 ? ' recommended' : '');
        
        const features = [
          'ì‹¤ì‹œê°„ ë³µì•½ ìˆœì‘ë„ ëª¨ë‹ˆí„°ë§',
          'ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼ ì‹œìŠ¤í…œ',
          'í™˜ìë³„ ë§ì¶¤ ê´€ë¦¬',
          'ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸',
          '24/7 ê³ ê° ì§€ì›'
        ];

        card.innerHTML = `
          <div class="plan-name">${plan.plan_name}</div>
          <div class="plan-price">
            ${plan.monthly_price.toLocaleString()}<span>ì›/ì›”</span>
          </div>
          <div class="plan-limit">
            ì¼ë³„ ìµœëŒ€ ${plan.daily_rx_limit === null || plan.daily_rx_limit >= 999999 ? 'ë¬´ì œí•œ' : plan.daily_rx_limit + 'ê±´'}
          </div>
          <ul class="plan-features">
            ${features.map(f => `<li>${f}</li>`).join('')}
          </ul>
          <button type="button" class="select-btn" data-plan-id="${plan.plan_id}" data-plan-name="${plan.plan_name}" data-plan-price="${plan.monthly_price}">
            ì„ íƒí•˜ê¸°
          </button>
        `;
        
        // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const selectBtn = card.querySelector('.select-btn');
        if (selectBtn) {
          console.log('ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡:', plan.plan_name);
          selectBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            console.log('ë²„íŠ¼ í´ë¦­ë¨!', plan.plan_id);
            
            // ì¦‰ì‹œ í˜ì´ì§€ ì´ë™
            const userId = localStorage.getItem('userId');
            if (!userId) {
              alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
              window.location.href = '/login';
              return false;
            }
            
            console.log('í˜ì´ì§€ ì´ë™:', `/subscription/payment?userId=${userId}&planId=${plan.plan_id}`);
            window.location.href = `/subscription/payment?userId=${userId}&planId=${plan.plan_id}`;
            return false;
          }, true); // capture ëª¨ë“œ
        } else {
          console.error('ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
        
        plansGrid.appendChild(card);
      });
    }

    // í”Œëœ ì„ íƒ
    async function selectPlan(planId, planName, price) {
      console.log('í”Œëœ ì„ íƒ:', planId, planName, price);
      
      try {
        const userId = localStorage.getItem('userId');
        if (!userId) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
        }
        
        // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™í•˜ë©´ì„œ í”Œëœ ì •ë³´ ì „ë‹¬ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì‚¬ìš©)
        console.log('í˜ì´ì§€ ì´ë™ ì‹œì‘:', `/subscription/payment?userId=${userId}&planId=${planId}`);
        window.location.href = `/subscription/payment?userId=${userId}&planId=${planId}`;
      } catch (error) {
        console.error('í”Œëœ ì„ íƒ ì—ëŸ¬:', error);
        alert('í”Œëœ ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // êµ¬ë… ìƒíƒœ í™•ì¸
    async function checkExistingSubscription() {
      const userId = localStorage.getItem('userId');
      if (!userId) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '/login';
        return false;
      }
      
      try {
        const response = await fetch(`/api/subscription/my?userId=${userId}`);
        const data = await response.json();
        
        console.log('êµ¬ë… í™•ì¸ ê²°ê³¼:', data);
        
        if (data.success && data.data) {
          // ì´ë¯¸ êµ¬ë… ì¤‘
          alert('ì´ë¯¸ êµ¬ë… ì¤‘ì…ë‹ˆë‹¤. ë‚´ êµ¬ë… ì •ë³´ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          window.location.href = '/my-subscription';
          return false;
        }
        // êµ¬ë… ì—†ìŒ - ì •ìƒ ì§„í–‰
        return true;
      } catch (error) {
        console.log('êµ¬ë… í™•ì¸ ì—ëŸ¬ (ì •ìƒ - êµ¬ë… ì—†ìŒ):', error);
        // êµ¬ë… ì—†ìŒ - ì •ìƒ ì§„í–‰
        return true;
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ êµ¬ë… í™•ì¸ í›„ í”Œëœ ë¶ˆëŸ¬ì˜¤ê¸°
    (async function() {
      const canProceed = await checkExistingSubscription();
      if (canProceed) {
        loadPlans();
      }
    })();
  </script>
</body>
</html>
